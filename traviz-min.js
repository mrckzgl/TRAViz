function TRAVizConnection(c,b,a){this.v1=c;this.v2=b;this.type=a;this.links=[]}TRAVizConnection.prototype.addLink=function(a){this.links.push(a)};function TRAVizVerticalConnection(c,b,a){this.v1=c;this.v2=b;this.type=a}TRAVizVerticalConnection.prototype.position=function(a,c,b){this.x1=a;this.x2=a;this.y1=c;this.y2=b};TRAVizVerticalConnection.prototype.yMin=function(){return Math.min(this.y1,this.y2)};TRAVizVerticalConnection.prototype.yMax=function(){return Math.max(this.y1,this.y2)};function TRAVizHorizontalConnection(c,b,a){this.v1=c;this.v2=b;this.type=a}TRAVizHorizontalConnection.prototype.position=function(b,a,c){this.x1=b;this.x2=a;this.y1=c;this.y2=c};function TRAVizGraph(a){this.config=a;this.vertices=[];this.vertexMap=[]}TRAVizGraph.prototype.getVertex=function(a){return this.vertexMap[a]};TRAVizGraph.prototype.removeVertex=function(b){var a=this.vertexMap[b];for(var c=0;c<a.successors.length;c++){this.vertexMap[a.successors[c]].removePredecessor(b)}for(var c=0;c<a.predecessors.length;c++){this.vertexMap[a.predecessors[c]].removeSuccessor(b)}for(var c=0;c<this.vertices.length;c++){if(this.vertices[c]==a){this.vertices.splice(c,1);break}}delete this.vertexMap[b]};TRAVizGraph.prototype.addVertex=function(a){this.vertices.push(a);this.vertexMap[a.index]=a};TRAVizGraph.prototype.clone=function(){var e=new TRAVizGraph();e.config=this.config;for(var d=0;d<this.vertices.length;d++){e.addVertex(new TRAVizVertex(e,this.vertices[d].index,this.vertices[d].token))}for(var d=0;d<this.vertices.length;d++){var a=this.vertices[d];var c=e.vertices[d];c.count=a.count;for(var b=0;b<a.sources.length;b++){c.sources.push(a.sources[b])}for(var b=0;b<a.successors.length;b++){c.addSuccessor(a.successors[b]);e.vertexMap[a.successors[b]].addPredecessor(c.index)}for(var b=0;b<a.predecessors.length;b++){c.addPredecessor(a.predecessors[b]);e.vertexMap[a.predecessors[b]].addSuccessor(c.index)}}return e};TRAVizGraph.prototype.isAcyclicFromVertex=function(k,h){var l=new TRAVizVertex(this,this.config.getVertexIndex(),k.token);this.addVertex(l);l.count=k.count+h.count;for(var f=0;f<k.sources.length;f++){l.sources.push(k.sources[f])}for(var f=0;f<h.sources.length;f++){l.sources.push(h.sources[f])}for(var f=0;f<k.predecessors.length;f++){var a=k.predecessors[f];if(a==k.index||a==h.index){a=l.index}l.addPredecessor(a);this.vertexMap[a].addSuccessor(l.index)}for(var f=0;f<h.successors.length;f++){var a=h.successors[f];if(a==k.index||a==h.index){a=l.index}l.addSuccessor(a);this.vertexMap[a].addPredecessor(l.index)}for(var f=0;f<k.successors.length;f++){var a=k.successors[f];if(a==k.index||a==h.index){a=l.index}l.addSuccessor(a);this.vertexMap[a].addPredecessor(l.index)}for(var f=0;f<h.predecessors.length;f++){var a=h.predecessors[f];if(a==k.index||a==h.index){a=l.index}l.addPredecessor(a);this.vertexMap[a].addSuccessor(l.index)}for(var f=0;f<this.vertices.length;f++){this.vertices[f].visited=0;this.vertices[f].limit=this.vertices[f].predecessors.length;for(var b=0;b<this.vertices[f].predecessors.length;b++){if(this.vertices[f].predecessors[b]==k.index){this.vertices[f].limit--}if(this.vertices[f].predecessors[b]==h.index){this.vertices[f].limit--}}}l.visited=l.limit;var c=[];for(var f=0;f<l.successors.length;f++){if(l.successors[f]!=k.index&&l.successors[f]!=h.index){c.push({head:l,tail:this.getVertex(l.successors[f])})}}while(c.length>0){var d=[];for(var f=0;f<c.length;f++){var g=c[f];g.tail.visited++;if(g.tail.visited>g.tail.limit){this.removeVertex(l.index);return false}for(var b=0;b<g.tail.successors.length;b++){if(l.successors[f]!=k.index&&l.successors[f]!=h.index&&g.tail.visited==1){d.push({head:g.tail,tail:this.getVertex(g.tail.successors[b])})}}}c=d}this.removeVertex(k.index);this.removeVertex(h.index);return l};TRAVizGraph.prototype.isAcyclic=function(){do{var f=this.vertices.length;for(var d=0;d<this.vertices.length;d++){var e=this.vertices[d];var c=e.successors,a=e.predecessors;if(c.length==0){for(var b=0;b<a.length;b++){this.vertexMap[a[b]].removeSuccessor(e.index)}e.predecessors=[]}}for(var d=this.vertices.length;d>0;d--){var e=this.vertices[d-1];if(e.successors.length==0&&e.predecessors.length==0){this.removeVertex(e.index)}}}while(f>this.vertices.length);if(this.vertices.length>0){return false}return true};TRAVizGraph.prototype.printVertices=function(){for(var c=0;c<this.vertices.length;c++){var a=this.vertices[c];for(var b=0;b<a.successors.length;b++){var d=this.getVertex(a.successors[b]);console.info(a.id+" ---> "+d.id,a.token+" ---> "+d.token)}}};function TRAVizVertex(c,a,b){this.graph=c;this.token=b;this.successors=[];this.predecessors=[];this.count=1;this.traced=false;this.linked=true;this.sources=[];this.index=a}TRAVizVertex.prototype.removeSuccessor=function(b){for(var a=0;a<this.successors.length;a++){if(this.successors[a]==b){this.successors.splice(a,1);return}}};TRAVizVertex.prototype.removePredecessor=function(a){for(var b=0;b<this.predecessors.length;b++){if(this.predecessors[b]==a){this.predecessors.splice(b,1);return}}};TRAVizVertex.prototype.addSuccessor=function(b){var c=false;for(var a=0;a<this.successors.length;a++){if(b==this.successors[a]){c=true;break}}if(!c){this.successors.push(b)}};TRAVizVertex.prototype.addPredecessor=function(a){var c=false;for(var b=0;b<this.predecessors.length;b++){if(a==this.predecessors[b]){c=true;break}}if(!c){this.predecessors.push(a)}};function TRAVizAligner(b,a){this.graph=b;this.config=a}TRAVizAligner.prototype.normalize=function(a){a=$("<p>"+a+"</p>").text();if(this.config.options.normalize){a=a.toLowerCase();a=a.replace(/--/g,"");a=a.replace(/,/g,"");a=a.replace(/\./g,"");a=a.replace(/;/g,"");a=a.replace(/:/g,"");a=a.replace(/\(/g,"");a=a.replace(/\)/g,"");a=a.replace(/\[/g,"");a=a.replace(/\]/g,"");a=a.replace(/\'/g,"");a=a.replace(/\"/g,"");a=a.replace(/´/g,"");a=a.replace(/`/g,"");a=a.replace(/“/g,"");a=a.replace(/”/g,"");if(a.lastIndexOf(" ")==a.length-1){a=a.substring(0,a.length-1)}}a=a.replace(/  /g," ");return a};TRAVizAligner.prototype.alignSentences=function(I){var h=this;var x=[];var f=[];var M=[];var a=undefined;var J=[];var L=[];for(var G=0;G<I.length;G++){var H=[];a=undefined;var m=this.normalize(I[G]);var s=m.split(" ");var r=[];for(var D=0;D<s.length;D++){var l=s[D];var g=s[D];var y=false;if(l.indexOf("<>")!=-1){y=l.substring(1,l.indexOf(">"));g=l.substring(l.indexOf(">")+1);g=g.substring(0,g.indexOf("<"));l=l.substring(0,l.indexOf(">")+1)+"<>"}var K={id:G+"-"+D,word:l,sid:G,wid:D,gid:x.length};x.push(K);H.push(K);r.push(K);var q=new TRAVizVertex(this.graph,this.config.getVertexIndex(),l);if(y){q.preferenceId=y;if(typeof L[y]=="undefined"){L[y]={vertices:[q],tokens:[g]}}else{L[y].vertices.push(q);L[y].tokens.push(g)}}q.sources.push({sourceId:G,token:l});this.graph.addVertex(q);if(typeof a!="undefined"){a.addSuccessor(q.index);q.addPredecessor(a.index)}a=q;f[K.id]=q}J.push(H);M.push(r)}var F=function(j,i){if(j.length>i.length){return -1}if(j.length==i.length){return 0}return 1};var N=[];var w=[];var A=[];var u=[];for(var G=0;G<x.length;G++){w.push([]);A.push(false);u.push(false)}for(var G=0;G<M.length-1;G++){for(var D=G+1;D<M.length;D++){var b=this.pairAlignment(M[G],M[D],[]);if(b.length==0){continue}b.sort(F);var z="";for(var C=0;C<b[0].length;C++){N.push({pair:b[0][C],value:2});var o=b[0][C].w1;var n=b[0][C].w2;w[o.gid].push(n);w[n.gid].push(o)}}}if(this.config.options.optimizeAlignment){for(var G=0;G<N.length;G++){var o=N[G].pair.w1;var n=N[G].pair.w2;for(var D=0;D<w[o.gid].length;D++){if(w[o.gid][D]==n){continue}for(var C=0;C<w[n.gid].length;C++){if(w[n.gid][C]==o){continue}if(w[o.gid][D]==w[n.gid][C]){N[G].value++}}}}var p=function(j,i){if(j.value>i.value){return -1}if(j.value==i.value){return 0}return 1};N.sort(p)}for(var G=0;G<L.length;G++){for(var D=0;D<L[G].vertices.length;D++){L[G].vertices[D].token=L[G].tokens[D]}}var B=function(k,j){var Q=h.graph.getVertex(f[k.id].index),P=h.graph.getVertex(f[j.id].index);if(Q==P){return}var t=h.graph.isAcyclicFromVertex(Q,P);if(t){for(var O=0;O<x.length;O++){if(f[x[O].id]==Q||f[x[O].id]==P){f[x[O].id]=t}}}};if(L.length>0){for(var G=0;G<N.length;G++){var d=h.graph.getVertex(f[o.id].index),c=h.graph.getVertex(f[n.id].index);if(d.preferenceId&&d.preferenceId==c.preferenceId){B(N[G].pair.w1,N[G].pair.w2);N[G].mark=true}}}for(var G=0;G<N.length;G++){if(!N[G].mark){B(N[G].pair.w1,N[G].pair.w2)}}var e=[];for(var G=0;G<J.length;G++){var E=[this.graph.startVertex];for(var D=0;D<J[G].length;D++){var q=f[J[G][D].id];if(D==0){this.graph.startVertex.addSuccessor(q.index);q.addPredecessor(this.graph.startVertex.index)}if(D==J[G].length-1){q.addSuccessor(this.graph.endVertex.index);this.graph.endVertex.addPredecessor(q.index)}E.push(q)}E.push(this.graph.endVertex);e.push(E)}return e};TRAVizAligner.prototype.getEditDistance=function(d,c){if(d.length===0){return c.length}if(c.length===0){return d.length}var e=[];var g;for(g=0;g<=c.length;g++){e[g]=[g]}var f;for(f=0;f<=d.length;f++){e[0][f]=f}for(g=1;g<=c.length;g++){for(f=1;f<=d.length;f++){if(c.charAt(g-1)==d.charAt(f-1)){e[g][f]=e[g-1][f-1]}else{e[g][f]=Math.min(e[g-1][f-1]+1,Math.min(e[g][f-1]+1,e[g-1][f]+1))}}}return e[c.length][d.length]};TRAVizAligner.prototype.pairAlignment=function(n,m){var l=[];for(var h=0;h<n.length;h++){l.push([]);for(var g=0;g<m.length;g++){if(this.config.options.editDistance){var a=this.getEditDistance(n[h].word,m[g].word);var e=2*a/(n[h].word.length+m[g].word.length);if(e<=this.config.options.editDistance){l[h].push(m[g])}}else{if(n[h].word==m[g].word){l[h].push(m[g])}}}}var q=[];for(var h=0;h<l.length;h++){var d=[];var o=function(v){var k=v[v.length-1];var s=false;var u=[];for(var r=d.length;r>0;r--){var t=d[r-1];var i=t[t.length-1];if(k.w2==i.w2&&v.length!=t.length){if(v.length<=t.length){u.push(t);s=true}}else{if(k.w2==i.w2&&v.length==t.length){u.push(t);s=true}else{u.push(t)}}}if(!s){u.push(v)}d=u};for(var f=0;f<q.length;f++){var p=q[f];o(p);var b=p[p.length-1].w2;for(var g=0;g<l[h].length;g++){var c=l[h][g];if(c.wid>b.wid){o(p.concat([{w1:n[h],w2:c}]))}}}for(var g=0;g<l[h].length;g++){o([{w1:n[h],w2:l[h][g]}])}q=d}return q};TRAVizAligner.prototype.strongestShortestPath=function(o){var c=0,b=1000000;var n=undefined;for(var e=0;e<o.successors.length;e++){var g=[o];var f=o.count;var l=1;var h=this.graph.getVertex(o.successors[e]);g.push(h);if(!h.traced){var m=h.successors;f+=h.count;while(m.length>0){var a=this.graph.getVertex(m[0]).count;var k=this.graph.getVertex(m[0]);for(var d=1;d<m.length;d++){if(this.graph.getVertex(m[d]).count>a){a=this.graph.getVertex(m[d]).count;k=this.graph.getVertex(m[d])}}l++;g.push(k);if(!k.traced){f+=a;m=k.successors}else{m=[]}}}if(l<b||l==b&&f>c){b=l;c=f;n=g}}return{strength:c,length:b,path:n}};TRAVizAligner.prototype.getPaths=function(b){for(var f=0;f<this.graph.vertices.length;f++){this.graph.vertices[f].traced=false}var a=b;for(var f=0;f<a.length;f++){a[f].traced=true}var l=[a];var g=true;var e=0;while(g){e++;g=false;var h=undefined;for(var f=0;f<this.graph.vertices.length;f++){var j=this.graph.vertices[f];if(j.traced){for(var d=0;d<j.successors.length;d++){if(!this.graph.getVertex(j.successors[d]).traced){var a=this.strongestShortestPath(this.graph.getVertex(j.successors[d]));a.path.splice(0,0,j);if(typeof h=="undefined"||h.length>a.length||h.length==a.length&&a.strength>h.strength){h=a}}}}else{g=true}}if(typeof h!="undefined"){for(var f=0;f<h.path.length;f++){h.path[f].traced=true}l.push(h.path)}}return l};TRAVizAligner.prototype.getPathsByEdition=function(d,k){var h=[];for(var f=0;f<k.length;f++){if(d!=k[f]){h.push(k[f])}}for(var f=0;f<this.graph.vertices.length;f++){this.graph.vertices[f].traced=false}var b=d;for(var f=0;f<b.length;f++){b[f].traced=true}var o=[b];while(h.length>0){var n=false,a=false,c=false;for(var f=0;f<h.length;f++){var m=0;var l=0;for(var e=0;e<h[f].length;e++){if(h[f][e].traced){m++}else{l+=h[f][e].count}}if(!n||m>n||m==n&&l>c){n=m;a=f;c=l}}var g=false;for(var f=0;f<h[a].length;f++){if(!g&&!h[a][f].traced){g=[h[a][f-1],h[a][f]]}else{if(g&&h[a][f].traced){g.push(h[a][f]);o.push(g);g=false}else{if(g&&!h[a][f].traced){g.push(h[a][f])}}}h[a][f].traced=true}if(g){o.push(g)}h.splice(a,1)}return o};function TRAViz(b,a){this.div=b;this.config=new TRAVizConfig(a);this.curveRadius=this.config.options.curveRadius;this.graph=new TRAVizGraph(this.config);this.startVertex=new TRAVizVertex(this.graph,"first","");this.graph.addVertex(this.startVertex);this.endVertex=new TRAVizVertex(this.graph,"last","");this.graph.addVertex(this.endVertex);this.graph.startVertex=this.startVertex;this.graph.endVertex=this.endVertex}TRAViz.prototype.align=function(a){this.editions=[];this.sentences=[];this.colorMap=[];var b=this.config.getColors(a.length);for(var g=0;g<a.length;g++){this.editions.push(a[g].edition);this.sentences.push(a[g].text);this.colorMap[a[g].edition]=b[g]}this.mainBranch=this.editions[0];this.aligner=new TRAVizAligner(this.graph,this.config);this.sentencePaths=this.aligner.alignSentences(this.sentences);this.sentencePathHash=[];for(var g=0;g<this.editions.length;g++){this.sentencePathHash[this.editions[g]]=this.sentencePaths[g]}this.vertices=this.aligner.graph.vertices;for(var g=0;g<this.vertices.length;g++){var m=this.vertices[g];var n="";var h=0;var l=[];for(var f=0;f<m.sources.length;f++){var d=m.sources[f].token;var o=false;for(var e=0;e<l.length;e++){if(l[e].t==d){l[e].c++;o=true;if(l[e].c>h){n=d;h=l[e].c}break}}if(!o){l.push({t:d,c:1});if(h==0){n=d;h=1}}}m.token=n}this.originGraph=this.graph.clone();this.originSentencePaths=[];for(var g=0;g<this.sentencePaths.length;g++){this.originSentencePaths.push([]);for(var f=0;f<this.sentencePaths[g].length;f++){this.originSentencePaths.push(this.sentencePaths[g][f])}}};TRAViz.prototype.loadGraphML=function(g){this.editions=[];this.sentences=[];this.colorMap=[];var a=this.config.getColors(sources.length);for(var f=0;f<sources.length;f++){this.editions.push(sources[f].edition);this.sentences.push(sources[f].text);this.colorMap[sources[f].edition]=a[f]}this.mainBranch=this.editions[0];this.aligner=new TRAVizAligner(this.graph,this.config);this.sentencePaths=this.aligner.alignSentences(this.sentences);this.sentencePathHash=[];for(var f=0;f<this.editions.length;f++){this.sentencePathHash[this.editions[f]]=this.sentencePaths[f]}this.vertices=this.aligner.graph.vertices;for(var f=0;f<this.vertices.length;f++){var m=this.vertices[f];var n="";var h=0;var l=[];for(var e=0;e<m.sources.length;e++){var b=m.sources[e].token;var o=false;for(var d=0;d<l.length;d++){if(l[d].t==b){l[d].c++;o=true;if(l[d].c>h){n=b;h=l[d].c}break}}if(!o){l.push({t:b,c:1});if(h==0){n=b;h=1}}}m.token=n}this.originGraph=this.graph.clone();this.originSentencePaths=[];for(var f=0;f<this.sentencePaths.length;f++){this.originSentencePaths.push([]);for(var e=0;e<this.sentencePaths[f].length;e++){this.originSentencePaths.push(this.sentencePaths[f][e])}}};TRAViz.prototype.reset=function(l){for(var f=0;f<this.sentencePaths.length;f++){var a=this.sentencePaths[f];for(var e=a.length;e>0;e--){if(a[e-1].dummy){a.splice(e-1,1)}}}for(var f=0;f<this.originGraph.vertices.length;f++){var l=this.originGraph.vertices[f];l.predecessors=[];l.successors=[]}for(var f=0;f<this.sentencePaths.length;f++){var a=this.sentencePaths[f];for(var e=0;e<a.length-1;e++){this.originGraph.getVertex(a[e].index).addSuccessor(a[e+1].index);this.originGraph.getVertex(a[e+1].index).addPredecessor(a[e].index)}}this.graph=this.originGraph.clone();this.aligner.graph=this.graph;this.vertices=this.graph.vertices;this.startVertex=this.graph.getVertex("first");this.endVertex=this.graph.getVertex("last");for(var f=0;f<this.sentencePaths.length;f++){var a=this.sentencePaths[f];for(var e=a.length;e>0;e--){a[e-1]=this.graph.getVertex(a[e-1].index)}}for(var f=0;f<this.vertices.length;f++){var l=this.vertices[f];l.layer=undefined;l.originLayer=undefined;var m="";var g=0;var h=[];for(var e=0;e<l.sources.length;e++){var b=l.sources[e].token;var n=false;for(var d=0;d<h.length;d++){if(h[d].t==b){h[d].c++;n=true;if(h[d].c>g){m=b;g=h[d].c}break}}if(!n){h.push({t:b,c:1});if(g==0){m=b;g=1}}}l.token=m}};TRAViz.prototype.setColorMap=function(a){this.colorMap=a};TRAViz.prototype.prepareConnections=function(){this.connections=[];var f=[];for(var m=0;m<this.layers.length;m++){var t={height:0,paths:[],index:this.layers[m].index};f.push(t)}var n=function(k,p){for(var j=0;j<f.length;j++){if(f[j].index==k){f[j].paths.push(p);break}}};var q=this;var l=function(){var p=1000000,B=0;for(var A=0;A<q.layout.length;A++){var E=q.layout[A];if(E.x1<p){p=E.x1}if(E.x2>B){B=E.x2}}var x=function(k,j){if(k.length!=j.length){return false}for(var v=0;v<k.length;v++){if(k[v]!=j[v]){return false}}return true};for(var A=0;A<f.length;A++){var F=f[A];var C=0;var w=[];for(var z=p;z<B;z++){var D=[];for(var y=0;y<F.paths.length;y++){if(F.paths[y].v1.x2<z&&F.paths[y].v2.x1>z){D.push(F.paths[y])}}if(D.length>0&&(w.length==0||!x(w[w.length-1],D))){w.push(D)}}var C=0;for(var z=0;z<w.length;z++){if(w[z].length>C){C=w[z].length}}F.height=C*3+2*q.curveRadius;F.groups=w}};for(var m=0;m<this.vertices.length;m++){var u=this.vertices[m];var d=u.successors;for(var h=0;h<d.length;h++){var s=u;var r=this.graph.getVertex(d[h]);if(!this.config.options.startAndEnd&&(s==this.startVertex||r==this.endVertex)){continue}if(u.token==""&&r.token==""&&!r.linebreak&&r!=this.endVertex){continue}if(s.layer==r.layer){var e=false;for(var g=0;g<this.vertices.length;g++){if(this.vertices[g]==s||this.vertices[g]==r){continue}if(this.vertices[g].layer==s.layer&&s.x1<this.vertices[g].x1&&this.vertices[g].x1<r.x1){e=true;break}}if(e){var c=new TRAVizConnection(s,r,0);var b=new TRAVizVerticalConnection(s,r,"source");var o=new TRAVizHorizontalConnection(s,r,0);var a=new TRAVizVerticalConnection(s,r,"sink");this.connections.push(c);c.addLink(b);c.addLink(o);c.addLink(a);n(s.layer,o)}else{this.connections.push(new TRAVizConnection(s,r,-1))}}else{var c=new TRAVizConnection(s,r,3);this.connections.push(c);var b=new TRAVizVerticalConnection(s,r,"source");var o=new TRAVizHorizontalConnection(s,r,3);var a=new TRAVizVerticalConnection(s,r,"sink");if(Math.abs(s.layer)>Math.abs(r.layer)){if(s.layer<0){n(s.layer+1,o)}else{n(s.layer,o)}}else{if(r.layer<0){n(r.layer+1,o)}else{n(r.layer,o)}}c.addLink(b);c.addLink(o);c.addLink(a)}}}l();this.horizontalSlots=f};TRAViz.prototype.addEdgeToGroup=function(d,b,k,c){var j=false;for(var a=0;a<this.edgeGroups.length;a++){var f=this.edgeGroups[a];if(f.h==d&&f.t==b){f.edges.push(k);f.ids=f.ids.concat(c);j=true;break}}if(!j){this.edgeGroups.push({h:d,t:b,edges:[k],ids:c})}};TRAViz.prototype.computeEdgeLabels=function(){for(var c=0;c<this.edgeGroups.length;c++){var d=this.edgeGroups[c];var b="";for(var a=0;a<d.ids.length;a++){b+="<div style='text-align:center;color:"+this.colorMap[this.editions[d.ids[a]]]+";'>"+this.editions[d.ids[a]]+"</div>"}for(var a=0;a<d.edges.length;a++){$(d.edges[a].node).qtip({content:{text:b},style:{tip:true,border:{width:0,radius:4},width:{min:100,max:500}},position:{target:"mouse",corner:{tooltip:"bottomMiddle",target:"topMiddle"},adjust:{x:-6}},show:{when:"mouseenter",solo:true},hide:{when:{event:"mouseleave"}}})}}};TRAViz.prototype.generalConnections=function(){for(var c=0;c<this.connections.length;c++){var d=this.generatePath(this.connections[c],0,0);var a=this.paper.path(d).attr({stroke:this.config.options.baseColor,"stroke-width":3,"stroke-linecap":"round",opacity:"0.8"});this.basicConnections.push(a)}for(var c=0;c<this.vertices.length;c++){var b=this.vertices[c];if(b==this.startVertex||b==this.endVertex||b.token==""){continue}if(this.config.options.vertexBackground){b.rect.toFront()}if(b.count>this.config.options.collapseLabels){b.textNode.toFront()}}};TRAViz.prototype.adjustVerticalConnections=function(){var z=[];for(var V=0;V<this.connections.length;V++){var X=this.connections[V];var l=X.v1.x2;var f=X.v2.x1;var L=(l+f)/2;var ac=(X.v1.y1+X.v1.y2)/2;var ab=(X.v2.y1+X.v2.y2)/2;if(X.type==1){var q,o;if(ac>ab){q=ac-this.curveRadius;o=ab+this.curveRadius}else{q=ac+this.curveRadius;o=ab-this.curveRadius}var u=X.links[0];u.position(L,q,o);z.push(u)}else{if(X.type==0||X.type==3){var W=X.links[1];var a=l+this.curveRadius;var J,H;if(X.v1.layer>=X.v2.layer){J=ac-this.curveRadius;H=W.y1+this.curveRadius}else{J=ac+this.curveRadius;H=W.y1-this.curveRadius}var x=X.links[0];x.position(a,J,H);z.push(x);var I=f-this.curveRadius;var E,D;if(X.v1.layer<=X.v2.layer){E=W.y1+this.curveRadius;D=ab-this.curveRadius}else{E=W.y1-this.curveRadius;D=ab+this.curveRadius}var w=X.links[X.links.length-1];w.position(I,E,D);z.push(w)}}}this.verticals=z;var d=function(h,c){if(h.x1<c.x1){return -1}if(h.x1==c.x1&&h.yMax()>c.yMax()){return -1}return 1};z.sort(d);var e=[];for(var U=0;U<z.length;U++){var g=false;var B=false;for(var S=0;S<e.length;S++){if((z[U].type=="source"||z[U].type==1)&&e[S].source==z[U].v1){g=true;e[S].paths.push(z[U]);if(z[U].yMin()<e[S].y1){e[S].y1=z[U].yMin()}if(z[U].yMax()>e[S].y2){e[S].y2=z[U].yMax()}}if((z[U].type=="sink"||z[U].type==1)&&e[S].sink==z[U].v2){B=true;e[S].paths.push(z[U]);if(z[U].yMin()<e[S].y1){e[S].y1=z[U].yMin()}if(z[U].yMax()>e[S].y2){e[S].y2=z[U].yMax()}}}if(!g&&z[U].type!="sink"){e.push({vertex:z[U].v1,source:z[U].v1,paths:[z[U]],y1:z[U].yMin(),y2:z[U].yMax(),x:z[U].v1.x2+this.curveRadius})}if(!B&&z[U].type!="source"){e.push({vertex:z[U].v2,sink:z[U].v2,paths:[z[U]],y1:z[U].yMin(),y2:z[U].yMax(),x:z[U].v2.x1-this.curveRadius})}}var N=function(h,c){if(h.paths.length>c.paths.length){return 1}if(h.paths.length==c.paths.length&&Math.abs(h.vertex.originLayer)<Math.abs(c.vertex.originLayer)){return 1}return -1};e.sort(N);var t=[];for(var U=e.length;U>0;U--){var T=e[U-1];var b=[];for(var S=0;S<T.paths.length;S++){if(!T.paths[S].placed){b.push(T.paths[S])}}if(b.length<T.paths.length){if(b.length==0){e.pop();continue}T.paths=b;e.sort(N);U=e.length+1;continue}for(var S=0;S<T.paths.length;S++){T.paths[S].placed=true}t.push(T);e.pop()}e=t;var C=function(h,c){if(h.x<c.x){return 1}if(h.x==c.x){if(h.paths.length>c.paths.length&&h.source){return 1}}return -1};e.sort(C);var F=[];for(var U=e.length;U>0;U--){var T=e[U-1];if(typeof T.source!="undefined"){var y=T.x;var P=T.paths[0].v1.x2+this.curveRadius;if(y!=P){T.x=P;e.sort(C);U=e.length+1;continue}}if(typeof T.sink!="undefined"){var y=T.x;var P=T.paths[0].v2.x1-this.curveRadius;if(y!=P){T.x=P;e.sort(C);U=e.length+1;continue}}do{var ad=false;for(var S=0;S<F.length;S++){var R=F[S];if(Math.abs(T.x-R.x)<this.config.options.edgeGap&&!(T.y1>R.y2||R.y1>T.y2)){ad=true;T.x+=this.config.options.edgeGap-Math.abs(T.x-R.x)}}}while(ad);for(var S=0;S<T.paths.length;S++){var M=T.paths[S];M.x1=T.x;M.x2=T.x;M.gc=T.paths.length;var G=M.v2;if(G.x1-T.x<this.curveRadius){var K=this.curveRadius-(G.x1-T.x);G.x1+=K;G.x2+=K;var A=[];for(var Q=0;Q<G.successors.length;Q++){if(G.level==this.graph.getVertex(G.successors[Q]).level){A.push({head:G,tail:this.graph.getVertex(G.successors[Q])})}}while(A.length>0){var Z=[];for(var Q=0;Q<A.length;Q++){var aa=A[Q].head;var Y=A[Q].tail;if(Y.x1-aa.x2<4*this.curveRadius){var r=4*this.curveRadius-(Y.x1-aa.x2);Y.x1+=r;Y.x2+=r;for(var O=0;O<Y.successors.length;O++){Z.push({head:Y,tail:this.graph.getVertex(Y.successors[O])})}}}A=Z}}}F.push(T);e.pop()}};TRAViz.prototype.removeVertical=function(a){for(var b=0;b<this.verticals.length;b++){if(this.verticals[b]==a){this.verticals.splice(b,1);return}}};TRAViz.prototype.removeOverlaps=function(){var w=function(j,i){if(j.x1>i.x1){return 1}if(j.x1==i.x1){return 0}return -1};for(var s=0;s<this.verticals.length;s++){for(var r=0;r<this.vertices.length;r++){if(this.vertices[r].token==""){continue}var a=this.verticals[s].x1-this.curveRadius,x=this.verticals[s].x2+this.curveRadius,o=this.verticals[s].yMin()-this.curveRadius,n=this.verticals[s].yMax()+this.curveRadius;var m=this.vertices[r].x1,l=this.vertices[r].x2,v=this.vertices[r].y1,u=this.vertices[r].y2;if(this.overlap(a,x,m,l,o,n,v,u)){var d=this.vertices[r];var t=Math.abs(this.vertices[r].x2-a);var p=Math.abs(d.x1-x);var h=false;var b=true;for(var q=0;q<this.vertices.length;q++){var e=this.vertices[q];if(d==e){continue}if(e==this.startVertex&&!this.config.options.startAndEnd){continue}var f=this.getConnection(e,d);if(!f){b=false}else{if(f.type==1&&f.links[0].x1+this.curveRadius>=d.x1-t){b=false}else{if(f.type==-1&&f.v2.x1-f.v1.x2-3*this.curveRadius<t){b=false}else{if(f.type!=-1&&f.type!=1){b=false}}}}}if(b){h=true;d.x1-=t;d.x2-=t}if(!h){var g=true;for(var q=0;q<this.vertices.length;q++){var c=this.vertices[q];if(d==c){continue}var f=this.getConnection(d,c);if(c==this.endVertex&&!this.config.options.startAndEnd){continue}if(!f){g=false}else{if(f.type==1&&f.links[0].x1-this.curveRadius<d.x2+p){g=false}else{if(f.type==-1&&f.v2.x1-f.v1.x2-3*this.curveRadius<p){g=false}else{if(f.type!=-1&&f.type!=1){g=false}}}}}if(g){h=true;d.x1+=p;d.x2+=p}}}}}};TRAViz.prototype.transformEdgeTypes=function(){var F=[];for(var w=0;w<this.connections.length;w++){var D=this.connections[w];if(D.type==1){var p=D.links[0];var l=(D.v1.y1+D.v1.y2)/2;var k=(D.v2.y1+D.v2.y2)/2;F.push({x1:D.v1.x2,x2:p.x1,y1:l,y2:l,v1:D.v1,v2:D.v2});F.push({x1:p.x1,x2:D.v2.x1,y1:k,y2:k,v1:D.v1,v2:D.v2})}}for(var w=0;w<this.connections.length;w++){var D=this.connections[w];if(D.type==0||D.type==3){var g=D.links[0];var z=D.links[1];var e=D.links[2];z.x1=g.x1+this.curveRadius;z.x2=e.x1-this.curveRadius}}var r=function(h,c){if(h.v1.x2>c.v1.x2){return 1}return -1};this.connections.sort(r);for(var w=0;w<this.connections.length;w++){var D=this.connections[w];if(D.type==3){var z=D.links[1];var l=(D.v1.y1+D.v1.y2)/2;var k=(D.v2.y1+D.v2.y2)/2;var a=z.x1-this.curveRadius,G=z.x2+this.curveRadius,u=D.v1.y1,t=D.v1.y2,f=D.v2.y1,d=D.v2.y2;var q=false;var o=false;for(var s=0;s<this.vertices.length;s++){var p=this.vertices[s];var n=p.x1,m=p.x2,E=p.y1,C=p.y2;if(this.overlap(a,G,n,m,u,t,E,C)){q=true;break}if(this.overlap(D.v2.x1-2*this.curveRadius,D.v2.x1,n,m,Math.min(l,k),Math.max(l,k),E,C)){}}for(var s=0;s<F.length;s++){var z=F[s];if(D.v1==z.v1||D.v2==z.v2){continue}if(this.overlap(a,G,z.x1,z.x2,u,t,z.y1,z.y2)){q=true;break}}for(var s=0;s<this.verticals.length;s++){var y=this.verticals[s];if(D.v2==y.v2){continue}if(this.overlap(D.links[2].x1,D.links[2].x1,y.x1-this.config.options.edgeGap,y.x2+this.config.options.edgeGap,Math.min(l,k),Math.max(l,k),Math.min(y.y1,y.y2),Math.max(y.y1,y.y2))){q=true;break}}for(var s=0;s<this.vertices.length;s++){var p=this.vertices[s];var n=p.x1,m=p.x2,E=p.y1,C=p.y2;if(this.overlap(a,G,n,m,f,d,E,C)){o=true;break}if(this.overlap(D.v1.x2,D.v1.x2+2*this.curveRadius,n,m,Math.min(l,k),Math.max(l,k),E,C)){}}for(var s=0;s<F.length;s++){var z=F[s];if(D.v1==z.v1||D.v2==z.v2){continue}if(this.overlap(a,G,z.x1,z.x2,f,d,z.y1,z.y2)){o=true;break}}for(var s=0;s<this.verticals.length;s++){var y=this.verticals[s];if(D.v1==y.v1){continue}if(this.overlap(D.links[0].x1,D.links[0].x1,y.x1-this.config.options.edgeGap,y.x2+this.config.options.edgeGap,Math.min(l,k),Math.max(l,k),Math.min(y.y1,y.y2),Math.max(y.y1,y.y2))){o=true;break}}var A=false,x=false;if(q&&!o){A=true}else{if(!q&&o){x=true}else{if(!q&&!o&&D.links[0].gc>D.links[2].gc){A=true}else{if(!q&&!o&&D.links[0].gc<D.links[2].gc){x=true}else{if(!q&&!o&&Math.abs(D.v1.originLayer)<Math.abs(D.v2.originLayer)){A=true}else{if(!q&&!o&&Math.abs(D.v1.originLayer)>=Math.abs(D.v2.originLayer)){x=true}}}}}}if(A){D.type=1;this.removeVertical(D.links[2]);var b=D.links[0];b.type="source";var B=(b.v1.layer+b.v2.layer)/2;if(b.v1.layer<B){b.y1=l+this.curveRadius;b.y2=k-this.curveRadius}else{b.y1=l-this.curveRadius;b.y2=k+this.curveRadius}D.links=[b];F.push({x1:a-this.curveRadius,x2:G+this.curveRadius,y1:f-this.curveRadius,y2:d+this.curveRadius,v1:D.v1,v2:D.v2})}if(x){D.type=1;this.removeVertical(D.links[0]);var b=D.links[2];b.type="sink";var B=(b.v1.layer+b.v2.layer)/2;if(b.v1.layer<B){b.y1=l+this.curveRadius;b.y2=k-this.curveRadius}else{b.y1=l-this.curveRadius;b.y2=k+this.curveRadius}D.links=[b];F.push({x1:a-this.curveRadius,x2:G+this.curveRadius,y1:t-this.curveRadius,y2:t+this.curveRadius,v1:D.v1,v2:D.v2})}}}};TRAViz.prototype.adjustHorizontalConnections=function(){var d=function(j,i){if(j.type==0&&i.type==0){if(j.x2-j.x1<i.x2-i.x1){return -1}return 1}else{if(j.type==0){return -1}else{if(i.type==0){return 1}else{if(j.x2==i.x2){if(j.x1<i.x1){return -1}return 1}else{if(j.x2<i.x2){return -1}}return 1}}}};for(var q=0;q<this.horizontalSlots.length;q++){var m=[];var v=this.horizontalSlots[q];var n=v.paths;for(var p=0;p<n.length;p++){var f=n[p];var s=f.v1.x2;var r=f.v2.x1;var h=v.yMax-2;f.position(s+2*this.curveRadius,r-2*this.curveRadius,h)}n.sort(d);var u=[];for(var p=0;p<n.length;p++){var g=false;var l=false;for(var o=0;o<u.length;o++){if(u[o].source==n[p].v1){g=true;u[o].paths.push(n[p]);if(n[p].x1<u[o].x1){u[o].x1=n[p].x1}if(n[p].x2>u[o].x2){u[o].x2=n[p].x2}}if(u[o].sink==n[p].v2){l=true;u[o].paths.push(n[p]);if(n[p].x1<u[o].x1){u[o].x1=n[p].x1}if(n[p].x2>u[o].x2){u[o].x2=n[p].x2}}}if(!g){u.push({source:n[p].v1,paths:[n[p]],x1:n[p].x1,x2:n[p].x2,y:n[p].y1})}if(!l){u.push({sink:n[p].v2,paths:[n[p]],x1:n[p].x1,x2:n[p].x2,y:n[p].y1})}}var e=function(j,i){if(j.paths.length>i.paths.length){return 1}return -1};u.sort(e);var c=[];for(var p=u.length;p>0;p--){var b=u[p-1];var t=[];for(var o=0;o<b.paths.length;o++){if(!b.paths[o].placed){t.push(b.paths[o])}}if(t.length<b.paths.length){b.paths=t;u.sort(e);p=u.length+1;continue}do{var a=false;for(var o=0;o<c.length;o++){var w=c[o];if(b.y==w.y&&!(b.x1-this.curveRadius>w.x2||w.x1-this.curveRadius>b.x2)){a=true;b.y-=this.config.options.edgeGap}}}while(a);for(var o=0;o<b.paths.length;o++){b.paths[o].placed=true;b.paths[o].y1=b.y;b.paths[o].y2=b.y}c.push(b);u.pop()}}};TRAViz.prototype.highlightEdition=function(e){var d=this.sentencePathHash[e];var c="";for(var b=1;b<d.length;b++){c+=this.generatePath(this.getConnection(d[b-1],d[b]),0,0)}var a=this.paper.path(c).attr({stroke:this.colorMap[e],"stroke-width":4,"stroke-linecap":"round",opacity:"1.0"});return a};TRAViz.prototype.insertLineNumbering=function(e,h){var a=1;var c=this.curveRadius;var b=e-this.curveRadius;var g=this.layers[0].yLevel-this.layers[0].height/2+0.5-Math.floor(h/2)-26;var f="M "+c+" "+g+" L "+b+" "+g;this.paper.path(f).attr({stroke:this.config.options.baseColor,"stroke-width":1,"stroke-linecap":"round",opacity:"1.0"});this.paper.text(c+7,g+14,this.config.options.lineNumberingText+" "+a).attr({font:"14px "+this.config.options.font,fill:this.config.options.baseColor,"text-anchor":"start",cursor:"default"});a++;for(var d=0;d<this.layers.length-1;d++){if(this.layers[d].level!=this.layers[d+1].level){var g=this.layers[d].yLevel+this.layers[d].height/2+0.5+Math.floor(h/2);var f="M "+c+" "+g+" L "+b+" "+g;this.paper.path(f).attr({stroke:this.config.options.baseColor,"stroke-width":1,"stroke-linecap":"round",opacity:"1.0"});this.paper.text(c+7,g+14,this.config.options.lineNumberingText+" "+a).attr({font:"14px "+this.config.options.font,fill:this.config.options.baseColor,"text-anchor":"start",cursor:"default"});a++}}var g=this.layers[this.layers.length-1].yLevel+this.layers[this.layers.length-1].height/2+0.5+Math.floor(h/2);var f="M "+c+" "+g+" L "+b+" "+g;this.paper.path(f).attr({stroke:this.config.options.baseColor,"stroke-width":1,"stroke-linecap":"round",opacity:"1.0"})};TRAViz.prototype.generatePath=function(t,e,d){var v=function(y,L,M,c,h,K){return"C "+y+" "+L+" "+M+" "+c+" "+h+" "+K+" "};var s=function(h,K,c,y){return"L "+h+" "+K+" "+c+" "+y+" "};var J=t;var G=J.v1.x2;var E=J.v2.x1;var j=(J.v1.y1+J.v1.y2)/2+e;var i=(J.v2.y1+J.v2.y2)/2+d;var A="M "+G+" "+j+" ";if(J.type==-1){var z=(E+G)/2;var I=(i+j)/2;A+=v(G,j,z,j,z,I);A+=v(z,I,z,i,E,i)}else{if(J.type==0||J.type==3){var g=J.links[0];var D=J.links[1];var f=J.links[2];var u=g.x1,r=g.x2,H=g.y1+e,F=g.y2;var n=D.x1,l=D.x2,C=D.y1,B=D.y2;var b=f.x1,a=f.x2,p=f.y1,o=f.y2+d;var x=this.curveRadius,w=this.curveRadius;if(Math.abs(C-j)<2*this.curveRadius){x=Math.abs(C-j)/2;var q=(C+j)/2;H=q;F=q}if(Math.abs(C-i)<2*this.curveRadius){w=Math.abs(C-i)/2;var q=(C+i)/2;p=q;o=q}if(this.config.options.rtl){x*=-1;w*=-1}A+=s(G,j,u-x,j);A+=v(u-x,j,u,j,u,H);A+=s(u,H,r,F);A+=v(r,F,r,C,n,C);A+=s(n,C,l,B);A+=v(l,B,b,B,b,p);A+=s(b,p,a,o);A+=v(a,o,a,i,a+w,i);A+=s(a+w,i,E,i)}else{if(J.type==1){var k=this.curveRadius;if(this.config.options.rtl){k*=-1}var m=J.links[0];A+=s(G,j,m.x1-k,j);A+=v(m.x1-k,j,m.x1,j,m.x1,m.y1+e);A+=s(m.x1,m.y1+e,m.x2,m.y2+d);A+=v(m.x2,m.y2+d,m.x2,i,m.x2+k,i);A+=s(m.x2+k,i,E,i)}}}return A};TRAViz.prototype.getConnection=function(c,b){for(var a=0;a<this.connections.length;a++){if(this.connections[a].v1==c&&this.connections[a].v2==b){return this.connections[a]}}return false};TRAViz.prototype.displayVertexConnections=function(b,f){this.vertexConnections=[];for(var e=0;e<this.vertices.length;e++){this.vertices[e].ins=[];this.vertices[e].outs=[]}for(var e=0;e<this.sentencePaths.length;e++){var a=this.sentencePaths[e];for(var d=0;d<a.length;d++){if(a[d]==f){for(var d=0;d<a.length;d++){if(d>0){a[d].ins.push({v:a[d-1],id:e})}if(d<a.length-1){a[d].outs.push({v:a[d+1],id:e})}}}}}for(var e=0;e<this.vertices.length;e++){var m=this.vertices[e];var k=(m.y1+m.y2)/2;if(this.vertices[e].token==""&&(this.vertices[e].ins.length<=1||this.vertices[e].outs.length<=1)){this.vertices[e].ins=[{}];this.vertices[e].outs=[{}]}this.vertices[e].ins.sort(function(p,j){var i=(p.v.y1+p.v.y2)/2;var c=(j.v.y1+j.v.y2)/2;if(p.v==j.v&&p.id>j.id){return 1}else{if(p.v!=j.v&&i==c&&p.v.x2>j.v.x2){return 1}else{if(p.v!=j.v&&i>c){return 1}}}return -1});this.vertices[e].outs.sort(function(p,j){var i=(p.v.y1+p.v.y2)/2;var c=(j.v.y1+j.v.y2)/2;if(p.v==j.v&&p.id>j.id){return 1}else{if(p.v!=j.v&&i==c&&p.v.x2<j.v.x2){return 1}else{if(p.v!=j.v&&i>c){return 1}}}return -1})}var h=function(p,j){if(j.length==1){return 0}for(var c=0;c<j.length;c++){if(j[c].id==p){return c*3-j.length*3/2}}};var l=function(q,p,c){if(p.length==1){return 0}for(var j=0;j<p.length;j++){if(p[j].id==q){return(j*3-p.length*3/2)/(p.length*2)*c/2}}};for(var e=0;e<this.sentencePaths.length;e++){var a=this.sentencePaths[e];for(var d=0;d<a.length;d++){if(a[d]==f){var o="";for(var d=1;d<a.length;d++){var g=this.getConnection(a[d-1],a[d]);if(g){if(this.config.options.interpolateFontSize){o+=this.generatePath(g,l(e,a[d-1].outs,a[d-1].boxHeight),l(e,a[d].ins,a[d].boxHeight))}else{o+=this.generatePath(g,h(e,a[d-1].outs),h(e,a[d].ins))}}}var n=this.paper.path(o).attr({stroke:this.colorMap[this.editions[e]],"stroke-width":3,"stroke-linecap":"round",opacity:"0.8"});n.node.setAttribute("class","edition"+e+"-edgestyle");this.vertexConnections.push(n);break}}}for(var e=0;e<this.vertices.length;e++){var m=this.vertices[e];if(m==this.startVertex||m==this.endVertex||m.token==""){continue}if(this.config.options.vertexBackground){m.rect.toFront()}if(m.count>this.config.options.collapseLabels){m.textNode.toFront()}}};TRAViz.prototype.majorityConnections=function(g){var d=[];for(var f=0;f<this.vertices.length;f++){for(var b=0;b<this.vertices[f].successors.length;b++){d.push({head:this.vertices[f],tail:this.graph.getVertex(this.vertices[f].successors[b]),weight:0,ids:[]})}}var s=function(u,p,t){for(var c=0;c<d.length;c++){var j=d[c];if(j.head==u&&j.tail==p){j.weight++;j.ids.push(t)}}};for(var f=0;f<this.sentencePaths.length;f++){var a=this.sentencePaths[f];s(this.startVertex,a[0],f);s(a[a.length-1],this.endVertex,f);for(var b=0;b<a.length-1;b++){s(a[b],a[b+1],f)}}for(var f=0;f<this.vertices.length;f++){this.vertices[f].ins=[];this.vertices[f].outs=[]}for(var f=0;f<d.length;f++){var h=d[f];if(g&&h.weight>this.sentencePaths.length*this.config.options.majorityPercentage){h.head.outs.push({v:h.tail,id:-1});h.tail.ins.push({v:h.head,id:-1})}else{for(var b=0;b<h.ids.length;b++){h.head.outs.push({v:h.tail,id:h.ids[b]});h.tail.ins.push({v:h.head,id:h.ids[b]})}}}for(var f=0;f<this.vertices.length;f++){var o=this.vertices[f];var m=(o.y1+o.y2)/2;if(this.vertices[f].token==""&&(this.vertices[f].ins.length<=1||this.vertices[f].outs.length<=1)){this.vertices[f].ins=[{}];this.vertices[f].outs=[{}]}this.vertices[f].ins.sort(function(j,i){var e=(j.v.y1+j.v.y2)/2;var c=(i.v.y1+i.v.y2)/2;if(j.v==i.v&&j.id>i.id){return 1}else{if(j.v!=i.v&&e==c&&j.v.x2>i.v.x2){return 1}else{if(j.v!=i.v&&e>c){return 1}}}return -1});this.vertices[f].outs.sort(function(j,i){var e=(j.v.y1+j.v.y2)/2;var c=(i.v.y1+i.v.y2)/2;if(j.v==i.v&&j.id>i.id){return 1}else{if(j.v!=i.v&&e==c&&j.v.x2<i.v.x2){return 1}else{if(j.v!=i.v&&e>c){return 1}}}return -1})}var l=function(j,e){if(e.length==1){return 0}for(var c=0;c<e.length;c++){if(e[c].id==j){return c*3-e.length*3/2}}};var n=function(p,j,c){if(j.length==1){return 0}for(var e=0;e<j.length;e++){if(j[e].id==p){return(e*3-j.length*3/2)/(j.length*2)*c/2}}};for(var f=0;f<d.length;f++){var h=d[f];var k=this.getConnection(h.head,h.tail);if(!k){continue}if(g&&h.weight>this.sentencePaths.length*this.config.options.majorityPercentage){var r=null;if(this.config.options.interpolateFontSize){r=this.generatePath(k,n(-1,h.head.outs,h.head.boxHeight),n(-1,h.tail.ins,h.tail.boxHeight))}else{r=this.generatePath(k,l(-1,h.head.outs),l(-1,h.tail.ins))}var q=this.paper.path(r).attr({stroke:this.config.options.baseColor,"stroke-width":5,"stroke-linecap":"round",opacity:"0.8"});q.node.setAttribute("class","majority-edgestyle");this.addEdgeToGroup(h.head,h.tail,q,h.ids);this.basicConnections.push(q)}else{for(var b=0;b<h.ids.length;b++){var r=null;if(this.config.options.interpolateFontSize){r=this.generatePath(k,n(h.ids[b],h.head.outs,h.head.boxHeight),n(h.ids[b],h.tail.ins,h.tail.boxHeight))}else{r=this.generatePath(k,l(h.ids[b],h.head.outs),l(h.ids[b],h.tail.ins))}var q=this.paper.path(r).attr({stroke:this.colorMap[this.editions[h.ids[b]]],"stroke-width":3,"stroke-linecap":"round",opacity:"0.8"});q.node.setAttribute("class","edition"+h.ids[b]+"-edgestyle");this.addEdgeToGroup(h.head,h.tail,q,[h.ids[b]]);this.basicConnections.push(q)}}}for(var f=0;f<this.vertices.length;f++){var o=this.vertices[f];if(o==this.startVertex||o==this.endVertex||o.token==""){continue}if(this.config.options.vertexBackground){o.rect.toFront()}if(o.count>this.config.options.collapseLabels){o.textNode.toFront()}}};TRAViz.prototype.setXFlow=function(){var o=4*this.curveRadius;var b=[];for(var r=0;r<this.startVertex.successors.length;r++){b.push({head:this.startVertex,tail:this.graph.getVertex(this.startVertex.successors[r])})}var a=this.startVertex.boxWidth;this.startVertex.x1=o;this.startVertex.x2=o+a;while(b.length>0){var y=[];for(var r=0;r<b.length;r++){var u=b[r];var t=o;if(u.tail.x1<u.head.x2+t){u.tail.x1=u.head.x2+t;u.tail.x2=u.head.x2+t+u.tail.boxWidth;for(var q=0;q<u.tail.successors.length;q++){y.push({head:u.tail,tail:this.graph.getVertex(u.tail.successors[q])})}}}b=y}var f=3;while(f>2){f=0;for(var r=0;r<this.vertices.length;r++){var m=this.vertices[r];if(m==this.startVertex||m==this.endVertex){continue}var c=Math.floor((m.x2+m.x1)/2);var k=m.boxWidth;var n=undefined,d=undefined;for(var q=0;q<m.predecessors.length;q++){var s=this.graph.getVertex(m.predecessors[q]);var l=s.x2;if(s==this.startVertex&&!this.config.options.startAndEnd){n=Math.floor(m.x1-o)}if(typeof n=="undefined"||l>n){n=l}}for(var q=0;q<m.successors.length;q++){var p=this.graph.getVertex(m.successors[q]);var h=p.x1;if(p==this.endVertex&&!this.config.options.startAndEnd){d=Math.floor(m.x2+o)}if(typeof d=="undefined"||h<d){d=h;xr=p}}var x=Math.floor((n+d)/2);if(isNaN(x)){x=c}if(x!=c){m.x1=x-k/2;m.x2=m.x1+k;if(f<Math.abs(x-c)){f=Math.abs(x-c)}}}}};TRAViz.prototype.overlap=function(e,c,b,g,d,a,h,f){if(e>=g||c<=b||d>=f||a<=h){return false}return true};TRAViz.prototype.getLayer=function(a){for(var b=0;b<this.layers.length;b++){if(this.layers[b].index==a){return this.layers[b]}}return false};TRAViz.prototype.getLayerIndex=function(a){for(var b=0;b<this.layers.length;b++){if(this.layers[b].index==a){return b}}return false};TRAViz.prototype.setConnections=function(){this.prepareConnections();var d=1000;for(var c=0;c<this.layers.length;c++){this.horizontalSlots[c].yMin=d+this.curveRadius;this.horizontalSlots[c].yMax=d-this.curveRadius+this.horizontalSlots[c].height;d+=this.layers[c].height/2+this.horizontalSlots[c].height;this.layers[c].yLevel=0+d;for(var b=0;b<this.layers[c].vertices.length;b++){var a=this.layers[c].vertices[b].boxHeight;this.layers[c].vertices[b].y1=d-a/2;this.layers[c].vertices[b].y2=d+a/2}d+=this.layers[c].height/2}this.adjustHorizontalConnections();this.adjustVerticalConnections()};TRAViz.prototype.insertDummys=function(p){var n=3*this.curveRadius;var m=function(i,e){if(i.x1<e.x1){return -1}return 1};this.vertices.sort(m);var v=this.vertices[0].x1-n;for(var u=0;u<this.vertices.length;u++){this.vertices[u].x1-=v;this.vertices[u].x2-=v;this.vertices[u].x1Temp=this.vertices[u].x1;this.vertices[u].x2Temp=this.vertices[u].x2}var f=this.vertices;var c=0;while(f.length>0){var o=[];var v=0;var b=0;for(var u=0;u<f.length;u++){if(f[u].x2Temp+2*n>p){if(v==0){v=3*n-f[u].x1Temp;f[u].x2Temp=f[u].x2Temp-f[u].x1Temp+3*n;f[u].x1Temp=3*n;b=(c+1)*p-f[u].x1+3*n}else{f[u].x1Temp+=v;f[u].x2Temp+=v}f[u].x1+=b;f[u].x2+=b;o.push(f[u])}else{f[u].level=c}}f=o;c++}var r=[];var d=[];for(var u=0;u<this.vertices.length;u++){for(var t=0;t<this.vertices[u].successors.length;t++){d.push({head:this.vertices[u],tail:this.graph.getVertex(this.vertices[u].successors[t])})}}var q=[];for(var u=0;u<d.length;u++){var w=d[u];if(w.tail.level!=w.head.level){var g,a;if(typeof r[w.tail.index+""]=="undefined"){g=new TRAVizVertex(this.graph,this.config.getVertexIndex(),"");g.dummy=true;g.predecessors=[w.head.index];w.head.removeSuccessor(w.tail.index);w.head.addSuccessor(g.index);a=new TRAVizVertex(this.graph,this.config.getVertexIndex(),"");a.dummy=true;a.successors=[w.tail.index];w.tail.removePredecessor(w.head.index);w.tail.addPredecessor(a.index);g.addSuccessor(a.index);a.addPredecessor(g.index);g.boxWidth=0,g.boxHeight=0;a.boxWidth=0,a.boxHeight=0;g.x1Temp=p-n,g.x2Temp=p-n;a.x1Temp=n,a.x2Temp=n;g.x1=(w.head.level+1)*p,g.x2=(w.head.level+1)*p;a.x1=(w.head.level+1)*p,a.x2=(w.head.level+1)*p;var l=[w.head,g,a,w.tail];q.push(l);this.graph.addVertex(g);this.graph.addVertex(a);g.level=w.head.level;a.level=w.head.level+1;this.layout.push(g);this.layout.push(a);if(w.head.token==""){g.linebreak=true}if(w.tail.level!=a.level){d.splice(u+1,0,{head:a,tail:w.tail})}else{r[w.tail.index+""]={h:g,t:a,path:l}}}else{g=r[w.tail.index+""].h;a=r[w.tail.index+""].t;w.head.removeSuccessor(w.tail.index);w.head.addSuccessor(g.index);w.tail.removePredecessor(w.head.index);w.tail.addPredecessor(a.index);g.addPredecessor(w.head.index);var l=r[w.tail.index+""].path;if(Math.abs(w.head.layer)<Math.abs(l[0].layer)||Math.abs(w.head.layer)==Math.abs(l[0].layer)&&w.head.x2>l[0].x2){l[0]=w.head}}for(var t=0;t<this.sentencePaths.length;t++){for(var s=0;s<this.sentencePaths[t].length-1;s++){if(this.sentencePaths[t][s]==w.head&&this.sentencePaths[t][s+1]==w.tail){this.sentencePaths[t].splice(s+1,0,g,a);break}}}}}var h=function(i,e){if(i[0].level<e[0].level){return -1}if(Math.abs(i[0].layer+i[3].layer)<Math.abs(e[0].layer+e[3].layer)){return -1}if(Math.abs(i[0].layer+i[3].layer)==Math.abs(e[0].layer+e[3].layer)&&i[3].x1-i[0].x2<e[3].x1-e[0].x2){return -1}return 1};q.sort(h);for(var u=0;u<q.length;u++){var l=q[u];var x=this.getYLayer(l[0].layer,l[3].layer,l[1],true);l[1].layer=x;l[2].layer=x}for(var u=0;u<this.vertices.length;u++){this.vertices[u].x1=this.vertices[u].x1Temp;this.vertices[u].x2=this.vertices[u].x2Temp}this.vertices=this.graph.vertices};TRAViz.prototype.setMainBranch=function(a){if(this.mainBranch!=a){this.mainBranch=a;this.reset();this.visualize()}};TRAViz.prototype.generateTranspositionPath=function(n,l){var d=function(s,u,v,q,r,t){return"C "+s+" "+u+" "+v+" "+q+" "+r+" "+t+" "};var p=function(r,t,q,s){return"L "+r+" "+t+" "+q+" "+s+" "};var c=n.x,b=l.x;var m,k,j,i,h;var f=this.getLayer(n.layer);var e=this.getLayer(l.layer);var g=Math.min(this.curveRadius,Math.abs(c-b)/2);if(f==e){var m=n.y2;var k=(n.y1+n.y2)/2+f.height/2;var j=(n.y1+n.y2)/2+f.height/2+g;var i=(l.y1+l.y2)/2+f.height/2;var h=l.y2}else{if(f.index<e.index){var a=this.horizontalSlots[this.getLayerIndex(n.layer)+1].yMax-this.horizontalSlots[this.getLayerIndex(n.layer)+1].yMin;var m=n.y2;var k=(n.y1+n.y2)/2+f.height/2+a/2;var j=(n.y1+n.y2)/2+f.height/2+a/2+g;var i=j+g;var h=l.y1}else{if(f.index>e.index){var a=this.horizontalSlots[this.getLayerIndex(n.layer)].yMax-this.horizontalSlots[this.getLayerIndex(n.layer)].yMin;var m=n.y1;var k=(n.y1+n.y2)/2-f.height/2-a/2;var j=(n.y1+n.y2)/2-f.height/2-a/2-g;var i=j-g;var h=l.y2}}}var o="M "+c+" "+m+" ";o+=p(c,m,c,k);o+=d(c,k,c,j,c+g,j);o+=p(c+g,j,b-g,j);o+=d(b-g,j,b,j,b,i);o+=p(b,i,b,h);return o};TRAViz.prototype.calculateTranspositions=function(){var a=[];for(var d=0;d<this.vertices.length;d++){if(this.vertices[d]==this.startVertex||this.vertices[d]==this.endVertex||this.vertices[d].token==""){continue}this.vertices[d].x=(this.vertices[d].x1+this.vertices[d].x2)/2;var f=false;for(var c=0;c<a.length;c++){if(a[c][0].token==this.vertices[d].token){a[c].push(this.vertices[d]);f=true;break}}if(!f){a.push([this.vertices[d]])}}for(var d=0;d<a.length;d++){var e=a[d];if(e.length==1){continue}for(var c=0;c<e.length;c++){e[c].transpositions=[];e[c].transpositionGroup=e;for(var b=0;b<e.length;b++){if(c==b){continue}var l="";if(e[c].x<e[b].x){l=this.generateTranspositionPath(e[c],e[b])}else{l=this.generateTranspositionPath(e[b],e[c])}var h=this.paper.path(l).attr({"stroke-width":3,"stroke-dasharray":".",opacity:"1.0"});$(h.node).css("display","none");e[c].transpositions.push(h)}}}};TRAViz.prototype.visualize=function(){var H=$("#"+this.div).width();if(this.config.options.lineBreaks){if(H==0){this.config.options.lineBreaks=false;alert("Please check the width of your container div!")}}var X=$(".trailsQtip");for(var af=0;af<X.length;af++){$(X[af]).remove()}var m=2*this.curveRadius;var ag=this;var u=[];var K=this.aligner.getPathsByEdition(this.sentencePathHash[this.mainBranch],this.sentencePaths);var ab=[];$("#"+this.div).empty();var T,S=1000;var z=function(e){if(!e){e=window.event}var c=(window.document.compatMode&&window.document.compatMode=="CSS1Compat")?window.document.documentElement:window.document.body;return{top:e.pageY?e.pageY:e.clientY,left:e.pageX?e.pageX:e.clientX}};var C=function(x,i,k){var r=z(x);var h=k.x1;var c=k.x2;var w=k.y1;var v=k.y2;var s=false;var e=false,j=false;document.onmouseup=function(){if(document.selection&&document.selection.empty){document.selection.empty()}else{if(window.getSelection){var an=window.getSelection();an.removeAllRanges()}}document.onmousemove=null;document.onmouseup=null;if(e&&!j){alert("Invalid merge attempt produced a circle in the graph!");s.attr({fill:ag.config.options.baseColor});e.textNode.attr({fill:ag.config.options.baseColor});$(s.node).fadeOut(1000,function(){$(s).remove()})}else{if(e&&j){var y=ag.originGraph.isAcyclicFromVertex(ag.originGraph.getVertex(e.index),ag.originGraph.getVertex(k.index));for(var am=0;am<ag.sentencePaths.length;am++){var ao=ag.sentencePaths[am];for(var al=0;al<ao.length;al++){if(ao[al]==e||ao[al]==k){ao[al]=y}}}ag.reset();ag.visualize()}else{$(s.node).fadeOut(1000,function(){$(s).remove()})}}};document.onmousemove=function(ap){if(!s){s=ag.paper.text((k.x1+k.x2)/2,(k.y1+k.y2)/2,k.token).attr({font:k.fs+"px "+ag.config.options.font,fill:ag.config.options.baseColor,"text-anchor":"middle",cursor:"pointer"})}if(document.selection&&document.selection.empty){document.selection.empty()}else{if(window.getSelection){var am=window.getSelection();am.removeAllRanges()}}var au=z(ap);s.x1=h+au.left-r.left;s.x2=c+au.left-r.left;s.y1=w+au.top-r.top;s.y2=v+au.top-r.top;s.attr({x:(s.x1+s.x2)/2,y:(s.y1+s.y2)/2});if(e){s.attr({fill:ag.config.options.baseColor});e.textNode.attr({fill:ag.config.options.baseColor})}e=false;j=false;var aq=0;for(var ao=0;ao<ag.vertices.length;ao++){var ax=s;var aw=ag.vertices[ao];if(k!=aw&&ag.overlap(ax.x1,ax.x2,aw.x1,aw.x2,ax.y1,ax.y2,aw.y1,aw.y2)){var al=(ax.x1+ax.x2)/2;var y=(aw.x1+aw.x2)/2;var av=(ax.y1+ax.y2)/2;var at=(aw.y1+aw.y2)/2;var ar=Math.sqrt((y-al)*(y-al)+(at-av)*(at-av));if(!e||e&&ar<aq){e=aw;aq=ar}}}if(e){var an=null;var ay=ag.originGraph.clone();j=ay.isAcyclicFromVertex(ag.originGraph.getVertex(e.index),ag.originGraph.getVertex(k.index));j?an="#90EE90":an="#FF8AA7";s.attr({fill:an});e.textNode.attr({fill:an})}}};var n=function(h,r){var c=new TRAVizVertex(ag.originGraph,ag.originGraph.config.getVertexIndex());ag.originGraph.addVertex(c);for(var j=0;j<h.sources.length;j++){if(h.sources[j].sourceId==r){c.sources.push(h.sources[j]);c.token=h.sources[j].token;h.sources.splice(j,1);break}}h.count--;var k=ag.sentencePaths[r];for(var j=0;j<k.length;j++){if(k[j].index==h.index){k[j]=c;break}}ag.reset();ag.visualize()};var J=function(r,s,v){var c=false;r.connections=[];var e=function(){for(var w=0;w<ag.basicConnections.length;w++){$(ag.basicConnections[w].node).css("display","none")}for(var w=0;w<ag.vertexConnections.length;w++){$(ag.vertexConnections[w].node).remove()}ag.displayVertexConnections(r,s,v);if(s.transpositions){for(var w=0;w<s.transpositions.length;w++){$(s.transpositions[w].node).css("display","block")}for(var w=0;w<s.transpositionGroup.length;w++){$(s.transpositionGroup[w].rect.node).attr({stroke:"#000","stroke-width":1,opacity:"1.0"})}}};var h=function(){for(var w=0;w<ag.vertexConnections.length;w++){$(ag.vertexConnections[w].node).remove()}for(var w=0;w<ag.basicConnections.length;w++){$(ag.basicConnections[w].node).css("display","block")}if(s.transpositions){for(var w=0;w<s.transpositions.length;w++){$(s.transpositions[w].node).css("display","none")}for(var w=0;w<s.transpositionGroup.length;w++){$(s.transpositionGroup[w].rect.node).attr({stroke:"none"})}}};$(r).mouseenter(function(){e()});$(r).mouseleave(function(){h()});if(ag.config.options.splitAndMerge){$(r).mousedown(function(i){C(i,r,s)})}var k="<table>";k+="<tr><th style='padding:5px;text-align:right;'>edition</th><th style='padding:5px;text-align:right;'>token</th></tr>";for(var j=0;j<s.sources.length;j++){k+="<tr>";k+="<td style='padding:5px;text-align:right;color:"+ag.colorMap[ag.editions[s.sources[j].sourceId]]+";'>"+ag.editions[s.sources[j].sourceId]+"</td>";k+="<td style='padding:5px;text-align:left;color:"+ag.colorMap[ag.editions[s.sources[j].sourceId]]+";'>"+s.sources[j].token+"</td>";if(ag.config.options.splitAndMerge&&s.sources.length>1){k+="<td><div title='Remove token and create new branch!' name="+s.sources[j].sourceId+" class='unlink unlink"+s.index+"'/></td>"}k+="</tr>"}k+="</table>";$(r).qtip({content:{text:k,title:{text:'<div>"'+s.token+'": '+s.sources.length+"&nbsp;"+ag.config.options.popupLabel+"</div>",button:"X"}},style:{tip:true,border:{width:0,radius:4}},position:{corner:{tooltip:"topMiddle",target:"bottomMiddle"}},show:{when:"click",solo:true},hide:{when:{event:"click"}},api:{onShow:function(){$("[qtip='"+this.id+"']").addClass("trailsQtip");$("[qtip='"+this.id+"']").mouseenter(function(){e()});$("[qtip='"+this.id+"']").mouseleave(function(){h()});if($(".qtip-content","[qtip='"+this.id+"']").height()>200){$(".qtip-content","[qtip='"+this.id+"']").css("height","200px");$(".qtip-content","[qtip='"+this.id+"']").css("overflow","auto")}if(!c){var w=$(".unlink"+s.index);if(w.length>0){for(var x=0;x<w.length;x++){$(w[x]).click(function(){n(ag.originGraph.getVertex(s.index),$(this).attr("name"))})}c=true}}},onHide:function(){h()}}})};var d=$("<label/>").appendTo("body");var P=new Date();this.layout=[];var o=0;for(var af=0;af<this.vertices.length;af++){if(this.vertices[af].count>o){o=this.vertices[af].count}}for(var af=0;af<K.length;af++){T=0;var ae=0,ad=K[af].length;if(af>0){ae++;ad--}var a=0,b=0;var q=[12,17,23,30,38,47,57];for(ae;ae<ad;ae++){var V=K[af][ae];var F=this.config.options.fontSizeMin+this.config.options.fontSizeIncrease*(V.count-1);if(this.config.options.interpolateFontSize){F=this.config.options.fontSizeMin+(V.count-1)/(o-1)*(this.config.options.fontSizeMax-this.config.options.fontSizeMin)}$(d).html(V.token);$(d).css("font",F+"px "+this.config.options.font);V.x1=T;if(V.count<=this.config.options.collapseLabels){$(d).html("M")}var I=$(d).width()+6;var l=$(d).height();V.boxWidth=I;V.boxHeight=l;V.x2=I+T;V.y1=S-l/2;V.y2=S+l/2;a+=I;if(ae>0){a+=m}if(l>b){b=l}this.layout.push(V)}ab.push(b)}$(d).remove();this.setXFlow();var L=$("<div id='TRAVizPaperDiv"+this.div+"'/>").appendTo("#"+this.div);var aa=Raphael("TRAVizPaperDiv"+this.div,10000,10000);this.layout=[];this.layers=[];var R=0;for(var af=0;af<K[0].length;af++){this.layout.push(K[0][af]);K[0][af].layer=0;if(K[0][af].boxHeight>R){R=K[0][af].boxHeight}}this.layers.push({index:0,height:R,vertices:[]});this.getYLayer=function(s,e,h,k){var c=e;if(Math.abs(s)>Math.abs(e)){c=s}var r=c;var j=function(w){if(typeof w!="undefined"){if(w>0){w*=-1}else{w=w*-1+1}c=r+w}else{w=0}if(!k&&c==0){j(w)}else{var x=false;for(var v=0;v<ag.layout.length;v++){if(ag.layout[v].layer==c){if(!(ag.layout[v].x1>h.x2||h.x1>ag.layout[v].x2)){x=true;break}}}if(x){j(w)}}};j();var i=this.getLayer(c);if(!i){i={index:c,height:0,vertices:[]};this.layers.push(i)}if(Math.abs(h.y2-h.y1)>i.height){i.height=Math.abs(h.y2-h.y1)}return c};for(var af=1;af<K.length;af++){var Z=K[af];var Y=Z[0];var ai=Z[Z.length-1];var ak=Z[1];var G=Z[Z.length-2];var A=new TRAVizVertex();A.x1=ak.x1-m;A.x2=G.x2+m;A.y1=(Y.y1+Y.y2)/2-ab[af]/2;A.y2=(Y.y1+Y.y2)/2+ab[af]/2;A.token=ak.token;var S=this.getYLayer(Y.layer,ai.layer,A);for(var ae=1;ae<Z.length-1;ae++){Z[ae].layer=S;this.layout.push(Z[ae])}}if(this.config.options.lineBreaks){this.insertDummys(H)}var M=this.layers.length;for(var af=0;af<this.vertices.length;af++){var V=this.vertices[af];if(typeof V.level=="undefined"){V.level=0}var B=this.getLayer(V.layer);V.originLayer=B.index;for(var ae=0;ae<B.vertices.length;ae++){if(B.vertices[ae]==V){B.vertices.splice(ae,1);break}}V.layer+=V.level*M;var f=this.getLayer(V.layer);if(!f){f={index:V.layer,height:0,vertices:[]};this.layers.push(f)}if(Math.abs(V.y2-V.y1)>f.height){f.height=Math.abs(V.y2-V.y1)}f.vertices.push(V)}var O=function(e,c){if(e.index<c.index){return -1}return 1};this.layers.sort(O);var Q=0;for(var af=0;af<this.layers.length;af++){if(this.layers[af].vertices.length>0){this.layers[af].level=this.layers[af].vertices[0].level;Q=this.layers[af].level}else{this.layers[af].level=Q}}this.setConnections();this.removeOverlaps();this.transformEdgeTypes();if(this.config.options.lineBreaks&&this.config.options.lineNumbering){for(var af=0;af<this.layout.length;af++){var V=this.layout[af];V.y1+=(V.level+1)*26;V.y2+=(V.level+1)*26}for(var af=0;af<this.connections.length;af++){var V=this.connections[af].v1;for(var ae=0;ae<this.connections[af].links.length;ae++){this.connections[af].links[ae].y1+=(V.level+1)*26;this.connections[af].links[ae].y2+=(V.level+1)*26}}for(var af=0;af<this.layers.length;af++){this.layers[af].yLevel+=(this.layers[af].level+1)*26}}var p=false;for(var af=0;af<this.startVertex.successors.length;af++){var D=this.graph.getVertex(this.startVertex.successors[af]);if(!p||D.x1-4*this.curveRadius<p){p=D.x1-4*this.curveRadius}}this.startVertex.x1=p;this.startVertex.x2=p;for(var af=0;af<this.startVertex.successors.length;af++){var aj=this.getConnection(this.startVertex,this.graph.getVertex(this.startVertex.successors[af]));if(aj.type==1&&aj.links[0].type=="source"){aj.links[0].x1=p+this.curveRadius;aj.links[0].x2=p+this.curveRadius}else{if(aj.type==3||aj.type==0){aj.links[0].x1=p+this.curveRadius;aj.links[0].x2=p+this.curveRadius;aj.links[1].x1=p+2*this.curveRadius}}}var E=0;for(var af=0;af<this.endVertex.predecessors.length;af++){var W=this.graph.getVertex(this.endVertex.predecessors[af]);if(W.x2+4*this.curveRadius>E){E=W.x2+4*this.curveRadius}}this.endVertex.x1=E;this.endVertex.x2=E;for(var af=0;af<this.endVertex.predecessors.length;af++){var aj=this.getConnection(this.graph.getVertex(this.endVertex.predecessors[af]),this.endVertex);if(aj.type==1&&aj.links[0].type=="sink"){aj.links[0].x1=E-this.curveRadius;aj.links[0].x2=E-this.curveRadius}else{if(aj.type==3||aj.type==0){aj.links[2].x1=E-this.curveRadius;aj.links[2].x2=E-this.curveRadius;aj.links[1].x2=E-2*this.curveRadius}}}var g=false,N=false;var ac=false,t=false;if(this.config.options.rtl){for(var af=0;af<this.layout.length;af++){this.layout[af].x1*=-1;this.layout[af].x2*=-1}for(var af=0;af<this.connections.length;af++){for(var ae=0;ae<this.connections[af].links.length;ae++){this.connections[af].links[ae].x1*=-1;this.connections[af].links[ae].x2*=-1}}}for(var af=0;af<this.layout.length;af++){var V=this.layout[af];if(!g||V.x1<g){g=V.x1}if(!N||V.x2>N){N=V.x2}if(!ac||V.y1<ac){ac=V.y1}if(!t||V.y2>t){t=V.y2}}ac-=3*this.curveRadius;t+=3*this.curveRadius+40;g-=3*this.curveRadius;N+=3*this.curveRadius;if(this.config.options.lineBreaks&&this.config.options.lineNumbering){ac-=26}var U=N-g;var ah=t-ac;if(this.config.options.lineBreaks){U=H}this.paper=aa;for(var af=0;af<this.layout.length;af++){var V=this.layout[af];V.y1-=ac;V.y2-=ac;if(!this.config.options.lineBreaks){V.x1-=g;V.x2-=g}}for(var af=0;af<this.connections.length;af++){for(var ae=0;ae<this.connections[af].links.length;ae++){this.connections[af].links[ae].y1-=ac;this.connections[af].links[ae].y2-=ac;if(!this.config.options.lineBreaks){this.connections[af].links[ae].x1-=g;this.connections[af].links[ae].x2-=g}}}aa.setSize(U+"px",ah+"px");for(var af=0;af<this.layers.length;af++){this.layers[af].yLevel-=ac}if(this.config.options.transpositions){this.calculateTranspositions()}for(var af=0;af<this.layout.length;af++){var V=this.layout[af];if(V!=this.startVertex&&V!=this.endVertex&&V.token!=""&&this.config.options.vertexBackground){if(V.count>this.config.options.collapseLabels){V.rect=aa.rect(V.x1+3,V.y1,V.x2-V.x1-6,V.y2-V.y1,5).attr({fill:this.config.options.vertexBackground,stroke:"none"})}else{V.rect=aa.rect(V.x1+3,V.y1,V.x2-V.x1-6,V.y2-V.y1,5).attr({title:V.token,fill:this.config.options.vertexBackground,stroke:"none"})}}if(V.count>this.config.options.collapseLabels){var F=this.config.options.fontSizeMin+this.config.options.fontSizeIncrease*(V.count-1);if(this.config.options.interpolateFontSize){F=this.config.options.fontSizeMin+(V.count-1)/(o-1)*(this.config.options.fontSizeMax-this.config.options.fontSizeMin)}V.fs=F;V.textNode=aa.text((V.x1+V.x2)/2,(V.y1+V.y2)/2,V.token).attr({font:F+"px "+this.config.options.font,fill:this.config.options.baseColor,"text-anchor":"middle",cursor:"pointer"});J(V.textNode.node,V,aa);$(V.textNode.node).css({"-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",})}}this.edgeGroups=[];this.basicConnections=[];this.vertexConnections=[];if(this.config.options.connectionType=="majority"){this.majorityConnections(true)}else{if(this.config.options.connectionType=="all"){this.majorityConnections(false)}else{this.generalConnections()}}if(this.config.options.editionLabels){this.computeEdgeLabels()}if(this.config.options.startAndEnd){aa.circle(this.startVertex.x1,this.startVertex.y1,4).attr({fill:this.config.options.baseColor});aa.rect(this.endVertex.x1,this.endVertex.y1-4,8,8).attr({fill:this.config.options.baseColor})}if(this.config.options.lineBreaks&&this.config.options.lineNumbering){this.insertLineNumbering(U,m)}$("<a class='TRAViz-copyright-link' target=_blank href='http://traviz.vizcovery.org'><div class='TRAViz-copyright'></div></a>").appendTo($("#"+this.div))};function TRAVizConfig(a){this.options={colors:["red","blue","green","rgb(230,230,0)","orange","#996600","purple","#FF00FF","#66FFFF","#339999"],normalize:true,lineBreaks:true,lineNumbering:true,lineNumberingText:"Line ",rtl:false,popupLabel:"occurrences",optimizedAlignment:true,editionLabels:true,baseColor:"#3E576F",vertexBackground:"rgba(242,242,242,0.75)",font:"Georgia",startAndEnd:true,collapseLabels:0,interpolateFontSize:false,fontSizeMin:10,fontSizeMax:50,fontSizeIncrease:4,edgeGap:5,curveRadius:10,connectionType:"all",majorityPercentage:0.5,editDistance:false,splitAndMerge:true,transpositions:true,};if(typeof a!="undefined"){$.extend(this.options,a)}}TRAVizConfig.prototype.getVertexIndex=function(){if(typeof this.vid=="undefined"){this.vid=0}return ++this.vid};TRAVizConfig.prototype.Hsv2rgb=function(d,n,k){var c,e,j;var i=d*6;if(i==6){i=0}var f=Math.floor(i);var a=k*(1-n);var m=k*(1-n*(i-f));var l=k*(1-n*(1-(i-f)));if(f==0){var_r=k;var_g=l;var_b=a}else{if(f==1){var_r=m;var_g=k;var_b=a}else{if(f==2){var_r=a;var_g=k;var_b=l}else{if(f==3){var_r=a;var_g=m;var_b=k}else{if(f==4){var_r=l;var_g=a;var_b=k}else{var_r=k;var_g=a;var_b=m}}}}}return"rgb("+Math.round(var_r*255)+","+Math.round(var_g*255)+","+Math.round(var_b*255)+")"};TRAVizConfig.prototype.getColors=function(b){var a=[];for(var c=0;c<b;c++){if(c>=this.options.colors.length){a.push(this.Hsv2rgb(((Math.random()*360)+1)/360,1,(25+(Math.random()*50)+1)/100))}else{a.push(this.options.colors[c])}}return a};